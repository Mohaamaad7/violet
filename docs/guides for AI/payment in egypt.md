# ุฏููู ุดุงูู ูุฏูุฌ ูุณุงุฆู ุงูุฏูุน ุงููุตุฑูุฉ ูู Laravel 12 ูุน Filament 4

**ููุฏุงููู ูุงุด ูุฅูุณุชุงุจุงู** ููุง ุฃุจุฑุฒ ูุณุงุฆู ุงูุฏูุน ุงูุฅููุชุฑููู ูู ูุตุฑุ ููู ุงูุชูุงูู ุงูุจุฑูุฌู ูุชู ุญุตุฑูุงู ุนุจุฑ ุจูุงุจุงุช ูุณูุทุฉ ูุซู **Paymob** ุงูุชู ุชููุฑ APIs ููุซูุฉ ูุจูุฆุงุช ุงุฎุชุจุงุฑ ุฌุงูุฒุฉ. ูุง ุชูุฌุฏ APIs ุฑุณููุฉ ูุจุงุดุฑุฉ ูู ููุฏุงููู ุฃู ุงูุจูู ุงููุฑูุฒู ูููุทูุฑููุ ููุง ูุฌุนู ุงูุงุนุชูุงุฏ ุนูู Payment Gateways ุถุฑูุฑุฉ ุชูููุฉ. ุงูุญู ุงูุฃูุซู ูู ุงุณุชุฎุฏุงู package ูุซู `nafezly/payments` ูุน Paymobุ ุงูุชู ุชุฏุนู **30+ ุจูุงุจุฉ ุฏูุน** ุจูุง ูููุง ุฌููุน ุงููุญุงูุธ ุงููุตุฑูุฉ.

---

## ููุฏุงููู ูุงุด: ุงููุญูุธุฉ ุงูุฃูุซุฑ ุงูุชุดุงุฑุงู ูู ูุตุฑ

ููุฏุงููู ูุงุด ูู ูุญูุธุฉ ุฅููุชุฑูููุฉ ุนูู ุงููุงุชู ุงููุญููู ุชูุฏููุง ููุฏุงููู ูุตุฑ ุจุงูุชุนุงูู ูุน ุจูู HSBCุ ูุชุฎุฏู ุญุงููุงู **25 ููููู ูุณุชุฎุฏู** ุจุญุตุฉ ุณูููุฉ ุชุชุฌุงูุฒ **55%** ูู ุฅุฌูุงูู ุงููุญุงูุธ ุงูุฅููุชุฑูููุฉ. ุชุชูุญ ูููุณุชุฎุฏููู ุฅุฌุฑุงุก ุงูุชุญูููุงุช ุงููุงููุฉุ ุฏูุน ุงูููุงุชูุฑุ ุงูุดุฑุงุก ุนุจุฑ ุงูุฅูุชุฑูุช ุจุงุณุชุฎุฏุงู ุจุทุงูุฉ ุงูุชุฑุงุถูุฉุ ูุงูุฏูุน ุนุจุฑ QR Code ูู ุงููุชุงุฌุฑ.

**ุงูุญุฏูุฏ ูุงูุฑุณูู (2025):**
- ุงูุญุฏ ุงููููู ูููุนุงููุงุช: **60,000 ุฌููู**
- ุงูุญุฏ ุงูุดูุฑู: **200,000 ุฌููู**
- ุฑุณูู ุงูุชุญููู ููุญูุธุฉ ููุฏุงููู ูุงุด: **1 ุฌููู**
- ุฑุณูู ุงูุชุญููู ููุญุงูุธ ุฃุฎุฑู: **0.5%** (ุญุฏ ุฃูุตู 15 ุฌููู)
- ุฅูุดุงุก ุจุทุงูุฉ ุงูุชุฑุงุถูุฉ ููุฏูุน ุฃูููุงูู: **10 ุฌููู**

**ูุง ููุฌุฏ API ุฑุณูู ูุจุงุดุฑ** ูู ููุฏุงููู ูุตุฑ ูููุทูุฑูู. ุงูุชูุงูู ูุชุงุญ ููุท ุนุจุฑ ูุณุทุงุก ุงูุฏูุน ุงููุฑุฎุตูู ูุซู Paymob ูFawaterak.

---

## ุฅูุณุชุงุจุงู: ุงูุจููุฉ ุงูุชุญุชูุฉ ุงููุทููุฉ ูููุฏููุนุงุช ุงููุญุธูุฉ

ุฅูุณุชุงุจุงู ูู ุงูุชุทุจูู ุงููุทูู ูููุฏููุนุงุช ุงููุญุธูุฉ ุงูุฐู ุฃุทููุชู ุดุฑูุฉ ุงูุจููู ุงููุตุฑูุฉ (EBC) ุจุชูุฌููุงุช ูู ุงูุจูู ุงููุฑูุฒู ุงููุตุฑู ูู ูุงุฑุณ 2022. ูุฎุฏู ุญุงููุงู **12 ููููู ูุณุชุฎุฏู** ููุชูุญ ุชุญูููุงุช ููุฑูุฉ 24/7 ุจูู ุงูุญุณุงุจุงุช ุงูุจูููุฉ ูุงููุญุงูุธ ุงูุฅููุชุฑูููุฉุ ูุน ุฏุนู ุงูุชุญููู ุจุฑูู ุงููุงุชู ุฃู IPA ุฃู IBAN.

**ุงูุญุฏูุฏ ูุงูุฑุณูู (ุจุฏุกุงู ูู ุฃุจุฑูู 2025):**
- ุงููุนุงููุฉ ุงููุงุญุฏุฉ: **70,000 ุฌููู**
- ุงูุญุฏ ุงููููู: **120,000 ุฌููู**
- ุงูุญุฏ ุงูุดูุฑู: **400,000 ุฌููู**
- ุฑุณูู ุงูุชุญูููุงุช: **0.1%** (ุญุฏ ุฃูุตู 20 ุฌููู)

**ูุง ููุฌุฏ API ุนุงู ูููุทูุฑูู ุญุงููุงู.** Paymob ุชุนูู ุฃู ุฏุนู InstaPay **"Coming Soon"**. ุงูุชูุงูู ุงูุญุงูู ููุชุฌุงุฑ ูุชู ุนุจุฑ QR Code ุฃู Payment Links ููุท.

### ุงูููุงุฑูุฉ ุงูุชูููุฉ ุจูู ุงููุธุงููู

| ุงููุนูุงุฑ | ููุฏุงููู ูุงุด | ุฅูุณุชุงุจุงู |
|---------|-------------|----------|
| **ููุน ุงูุฎุฏูุฉ** | ูุญูุธุฉ ุฅููุชุฑูููุฉ | ุดุจูุฉ ูุฏููุนุงุช ุจูู ุงูุจููู |
| **ุนุฏุฏ ุงููุณุชุฎุฏููู** | 25 ููููู | 12 ููููู |
| **API ูููุทูุฑูู** | ุนุจุฑ Paymob/Fawaterak โ | ุบูุฑ ูุชุงุญ ุญุงููุงู โ |
| **Sandbox** | ูุชุงุญุฉ ุนุจุฑ Paymob | ุบูุฑ ูุชุงุญุฉ |
| **ุณูููุฉ ุงูุชูุงูู** | ุณูู | ุตุนุจ |

---

## Paymob: ุงูุจูุงุจุฉ ุงูุฃูุซู ููุชูุงูู

Paymob ูู ุจูุงุจุฉ ุงูุฏูุน ุงูุฃูุซุฑ ุดููููุฉ ูู ูุตุฑุ ูุชููุฑ ุฃูุถู ุชูุซูู ุชููู ูุฏุนู ูุฌููุน ูุณุงุฆู ุงูุฏูุน ุงููุตุฑูุฉ.

**ุฑูุงุจุท ุงูุชูุซูู ุงูุฃุณุงุณูุฉ:**
- ุจูุงุจุฉ ุงููุทูุฑูู: `https://developers.paymob.com`
- ุชูุซูู ูุตุฑ: `https://developers.paymob.com/egypt`
- Payouts API: `https://payouts.paymobsolutions.com/docs/instant_cashin_api/`

**ุทุฑู ุงูุฏูุน ุงููุฏุนููุฉ:**
- ุจุทุงูุงุช Visa/Mastercard/Meeza
- ุงููุญุงูุธ ุงูุฅููุชุฑูููุฉ: Vodafone Cashุ Orange Moneyุ Etisalat Cashุ Meeza Wallet
- Apple Pay
- Kiosk (ุฃูุงู/ูุตุงุฑู)
- ุฃูุณุงุท ุงูุจููู
- BNPL: ValUุ Souhoolaุ Halanุ SYMPLุ ูุบูุฑูุง

**ุงูุฑุณูู:**
- ุงูุจุทุงูุงุช: **2.75% + 3 ุฌููู** ููู ูุนุงููุฉ ูุงุฌุญุฉ
- ูุง ุฑุณูู ุดูุฑูุฉ ุฃู ุงุดุชุฑุงู
- ุงูุชุณููุฉ ุฃุณุจูุนูุงู ุฅูู ุงูุญุณุงุจ ุงูุจููู

**ุนูููุฉ ุงูุชุณุฌูู:**
1. ุงูุชุณุฌูู ูู `https://accept.paymob.com`
2. ุฑูุน ุงูุณุฌู ุงูุชุฌุงุฑู ูุงูุจุทุงูุฉ ุงูุถุฑูุจูุฉ ููููุฉ ุงููุงูู
3. ุงูุชุธุงุฑ ุงูุชุญูู (ุญุชู 3 ุฃูุงู)
4. ุงูุญุตูู ุนูู API Key ูIntegration ID ูู Dashboard

**ุจูุงูุงุช ุงูุงุฎุชุจุงุฑ (Sandbox):**
```
Card Number: 4987654321098769
Expiry: 12/25
CVV: 123
Mobile Wallet Test: 01010101010 (PIN & OTP: 123456)
```

### ููุงุฑูุฉ ุจูุงุจุงุช ุงูุฏูุน ุงููุตุฑูุฉ

| ุงูููุฒุฉ | Paymob | Fawry | Kashier |
|--------|--------|-------|---------|
| **ุฑุณูู ุงูุจุทุงูุงุช** | 2.75% + 3 EGP | ~2.50% | 2.85% + 3 EGP |
| **ุฑุณูู ุดูุฑูุฉ** | ูุง | 500 EGP | ูุง |
| **ููุฏุงููู ูุงุด** | โ | โ | โ |
| **InstaPay** | ๐ ูุฑูุจุงู | โ | โ |
| **ุฌูุฏุฉ ุงูุชูุซูู** | โญโญโญโญโญ | โญโญโญโญ | โญโญโญโญ |
| **Mobile SDK** | iOS, Android, Flutter, React Native | iOS, Android | ูุญุฏูุฏ |

---

## Laravel Packages ููุฏูุน ุงููุตุฑู

### nafezly/payments (ุงูููุตู ุจู ุจุดุฏุฉ)

ุฃูุถู package ุดุงููุฉ ููุฏูุน ูู ูุตุฑ ูุน ุฏุนู **30+ ุจูุงุจุฉ** ูุฌููุน ุงููุญุงูุธ ุงูุฅููุชุฑูููุฉ ุงููุตุฑูุฉ.

```bash
composer require nafezly/payments dev-master
php artisan vendor:publish --tag="nafezly-payments-config"
```

| ุงููุนูุงุฑ | ุงูุชูุงุตูู |
|---------|----------|
| **GitHub** | github.com/Nafezly/payments |
| **ุงููุฌูู** | 458 โญ |
| **Downloads** | 15,535+ |
| **Laravel ุงููุฏุนูู** | 6.0+ (ูุฏุนู Laravel 11/12 ูุธุฑูุงู) |

**ูุชุบูุฑุงุช ุงูุจูุฆุฉ (.env):**
```env
PAYMOB_API_KEY=your_api_key
PAYMOB_INTEGRATION_ID=your_integration_id
PAYMOB_IFRAME_ID=your_iframe_id
PAYMOB_HMAC=your_hmac_secret
PAYMOB_WALLET_INTEGRATION_ID=your_wallet_integration_id
```

### Packages ุจุฏููุฉ

| Package | Downloads | ุขุฎุฑ ุชุญุฏูุซ | Laravel 11/12 |
|---------|-----------|-----------|---------------|
| basketin/laravel-paymob | 2,170 | Aug 2024 | โ |
| madarit/laravel-kashier | ุฌุฏูุฏุฉ | Nov 2025 | โ |
| paymob/laravel-package (ุฑุณููุฉ) | 270 | May 2024 | โ๏ธ |

---

## Laravel 12 ู Filament 4: ุฃุญุฏุซ ุงูุฅุตุฏุงุฑุงุช

### Laravel 12

ุตุฏุฑ ูู **24 ูุจุฑุงูุฑ 2025** ูุฅุตุฏุงุฑ ุตูุงูุฉ ูุน ุงูุญุฏ ุงูุฃุฏูู ูู ุงูุชุบููุฑุงุช ุงูุฌุฐุฑูุฉ. ูุนุธู ุชุทุจููุงุช Laravel ูููููุง ุงูุชุฑููุฉ ุฏูู ุชุนุฏูู ุงูููุฏ. ูุชุทูุจ **PHP 8.2+**.

**ูุง ุชูุฌุฏ ุชุบููุฑุงุช ุชุคุซุฑ ุนูู Payment Integrations** - ูุธุงู Queue ูNotifications ูุงูDatabase ูุนูู ููุง ูู Laravel 11.

### Filament 4

ุตุฏุฑุช ุงููุณุฎุฉ ุงููุณุชูุฑุฉ ูู ุฏูุณูุจุฑ 2025 ูุน ุชุญุณููุงุช ุฃุฏุงุก ูุงุฆูุฉ: **ุณุฑุนุฉ ุนุฑุถ ุงูุฌุฏุงูู ุฃุณุฑุน 2-3x**ุ ููุธุงู Schema ููุญุฏ ููู Forms ูุงูTablesุ ูุฏุนู Nested Resources ูMFA ุงููุฏูุฌ.

**ุงููุชุทูุจุงุช:** PHP 8.2+ุ Laravel 11.28+ุ Tailwind CSS v4.1+

---

## Database Structure ูููุฏููุนุงุช

### Migration ูููุฏููุนุงุช

```php
// database/migrations/create_payments_table.php
Schema::create('payments', function (Blueprint $table) {
    $table->id();
    $table->foreignId('user_id')->constrained()->cascadeOnDelete();
    $table->foreignId('order_id')->nullable()->constrained();
    $table->string('reference')->unique();
    $table->string('transaction_id')->nullable()->unique();
    $table->decimal('amount', 10, 2);
    $table->string('currency', 3)->default('EGP');
    $table->enum('payment_method', [
        'vodafone_cash', 'orange_money', 'etisalat_cash',
        'credit_card', 'meeza', 'fawry', 'instapay'
    ]);
    $table->enum('status', [
        'pending', 'processing', 'completed', 'failed', 'refunded', 'cancelled'
    ])->default('pending');
    $table->string('gateway')->default('paymob');
    $table->string('gateway_reference')->nullable();
    $table->json('gateway_response')->nullable();
    $table->string('failure_reason')->nullable();
    $table->timestamp('paid_at')->nullable();
    $table->timestamp('refunded_at')->nullable();
    $table->string('idempotency_key')->unique()->nullable();
    $table->string('ip_address')->nullable();
    $table->string('user_agent')->nullable();
    $table->timestamps();
    $table->softDeletes();
    
    $table->index(['user_id', 'status']);
    $table->index(['gateway', 'gateway_reference']);
    $table->index('created_at');
});
```

### Payment Model

```php
// app/Models/Payment.php
namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\Casts\Attribute;

class Payment extends Model
{
    use SoftDeletes;

    protected $fillable = [
        'user_id', 'order_id', 'reference', 'transaction_id',
        'amount', 'currency', 'payment_method', 'status',
        'gateway', 'gateway_reference', 'gateway_response',
        'failure_reason', 'paid_at', 'refunded_at',
        'idempotency_key', 'ip_address', 'user_agent'
    ];

    protected $casts = [
        'amount' => 'decimal:2',
        'gateway_response' => 'encrypted:array',
        'paid_at' => 'datetime',
        'refunded_at' => 'datetime',
    ];

    // Relationships
    public function user(): BelongsTo
    {
        return $this->belongsTo(User::class);
    }

    public function order(): BelongsTo
    {
        return $this->belongsTo(Order::class);
    }

    // Scopes
    public function scopeCompleted($query)
    {
        return $query->where('status', 'completed');
    }

    public function scopePending($query)
    {
        return $query->where('status', 'pending');
    }

    public function scopeByGateway($query, string $gateway)
    {
        return $query->where('gateway', $gateway);
    }

    // Helper Methods
    public function isPending(): bool
    {
        return $this->status === 'pending';
    }

    public function isCompleted(): bool
    {
        return $this->status === 'completed';
    }

    public function canBeRefunded(): bool
    {
        return $this->status === 'completed' 
            && $this->paid_at->diffInDays(now()) <= 30;
    }

    public function markAsCompleted(string $transactionId): void
    {
        $this->update([
            'status' => 'completed',
            'transaction_id' => $transactionId,
            'paid_at' => now(),
        ]);
    }

    public function markAsFailed(string $reason): void
    {
        $this->update([
            'status' => 'failed',
            'failure_reason' => $reason,
        ]);
    }

    // Generate unique reference
    public static function generateReference(): string
    {
        do {
            $reference = 'PAY-' . strtoupper(bin2hex(random_bytes(8)));
        } while (self::where('reference', $reference)->exists());
        
        return $reference;
    }
}
```

---

## Payment Service Architecture

### PaymentService

```php
// app/Services/PaymentService.php
namespace App\Services;

use App\Models\Payment;
use App\Models\User;
use App\Jobs\ProcessPaymentCallback;
use App\Notifications\PaymentSuccessNotification;
use App\Notifications\PaymentFailedNotification;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Nafezly\Payments\Facades\Payments;

class PaymentService
{
    public function initiatePayment(User $user, array $data): array
    {
        return DB::transaction(function () use ($user, $data) {
            // ุฅูุดุงุก ุณุฌู ุงูุฏูุน
            $payment = Payment::create([
                'user_id' => $user->id,
                'order_id' => $data['order_id'] ?? null,
                'reference' => Payment::generateReference(),
                'amount' => $data['amount'],
                'currency' => $data['currency'] ?? 'EGP',
                'payment_method' => $data['payment_method'],
                'status' => 'pending',
                'gateway' => 'paymob',
                'idempotency_key' => $data['idempotency_key'] ?? null,
                'ip_address' => request()->ip(),
                'user_agent' => request()->userAgent(),
            ]);

            // ุชุญุฏูุฏ ุงูุจูุงุจุฉ ุญุณุจ ูุณููุฉ ุงูุฏูุน
            $gateway = $this->resolveGateway($data['payment_method']);
            
            // ุฅูุดุงุก ุทูุจ ุงูุฏูุน
            $response = Payments::$gateway()->pay(
                amount: $payment->amount,
                user_id: $user->id,
                user_first_name: $user->first_name,
                user_last_name: $user->last_name,
                user_email: $user->email,
                user_phone: $user->phone,
                source: $data['source'] ?? $user->phone,
            );

            // ุชุญุฏูุซ ุงูุณุฌู ุจูุนูููุงุช ุงูุจูุงุจุฉ
            $payment->update([
                'gateway_reference' => $response['payment_id'] ?? null,
                'gateway_response' => $response,
            ]);

            Log::channel('payments')->info('Payment initiated', [
                'payment_id' => $payment->id,
                'reference' => $payment->reference,
                'amount' => $payment->amount,
                'method' => $payment->payment_method,
            ]);

            return [
                'payment' => $payment,
                'redirect_url' => $response['redirect_url'] ?? null,
                'iframe_url' => $response['html'] ?? null,
            ];
        });
    }

    public function handleCallback(array $data): Payment
    {
        $payment = Payment::where('gateway_reference', $data['payment_id'])
            ->orWhere('reference', $data['merchant_order_id'] ?? null)
            ->firstOrFail();

        // ุงูุชุญูู ูู HMAC
        if (!$this->verifyHmac($data)) {
            Log::channel('payments')->warning('Invalid HMAC', [
                'payment_id' => $payment->id,
                'data' => $data,
            ]);
            throw new \Exception('Invalid payment signature');
        }

        // ุชุญุฏูุซ ุญุงูุฉ ุงูุฏูุน
        if ($data['success'] === 'true' || $data['success'] === true) {
            $payment->markAsCompleted($data['transaction_id']);
            $payment->user->notify(new PaymentSuccessNotification($payment));
        } else {
            $payment->markAsFailed($data['error_message'] ?? 'Payment declined');
            $payment->user->notify(new PaymentFailedNotification($payment));
        }

        return $payment->fresh();
    }

    public function refund(Payment $payment, ?float $amount = null): bool
    {
        if (!$payment->canBeRefunded()) {
            throw new \Exception('Payment cannot be refunded');
        }

        $refundAmount = $amount ?? $payment->amount;
        
        $response = Payments::paymob()->refund(
            transaction_id: $payment->transaction_id,
            amount: $refundAmount * 100, // ุจุงููุฑูุด
        );

        if ($response['success']) {
            $payment->update([
                'status' => 'refunded',
                'refunded_at' => now(),
            ]);
            return true;
        }

        return false;
    }

    protected function resolveGateway(string $method): string
    {
        return match($method) {
            'vodafone_cash', 'orange_money', 'etisalat_cash' => 'paymobWallet',
            'credit_card', 'meeza' => 'paymob',
            'fawry' => 'fawry',
            default => 'paymob',
        };
    }

    protected function verifyHmac(array $data): bool
    {
        $hmacSecret = config('nafezly-payments.PAYMOB_HMAC');
        
        // ุชุฑุชูุจ ุงูุญููู ุญุณุจ ุชูุซูู Paymob
        $fields = [
            'amount_cents', 'created_at', 'currency', 'error_occured',
            'has_parent_transaction', 'id', 'integration_id', 'is_3d_secure',
            'is_auth', 'is_capture', 'is_refunded', 'is_standalone_payment',
            'is_voided', 'order.id', 'owner', 'pending',
            'source_data.pan', 'source_data.sub_type', 'source_data.type', 'success'
        ];
        
        $concatenated = '';
        foreach ($fields as $field) {
            $concatenated .= data_get($data, $field, '');
        }
        
        $calculatedHmac = hash_hmac('sha512', $concatenated, $hmacSecret);
        
        return hash_equals($calculatedHmac, $data['hmac'] ?? '');
    }
}
```

### PaymentController

```php
// app/Http/Controllers/PaymentController.php
namespace App\Http\Controllers;

use App\Http\Requests\InitiatePaymentRequest;
use App\Services\PaymentService;
use Illuminate\Http\Request;

class PaymentController extends Controller
{
    public function __construct(
        private PaymentService $paymentService
    ) {}

    public function initiate(InitiatePaymentRequest $request)
    {
        $result = $this->paymentService->initiatePayment(
            user: auth()->user(),
            data: $request->validated()
        );

        if ($result['redirect_url']) {
            return redirect()->away($result['redirect_url']);
        }

        return response()->json([
            'success' => true,
            'payment' => $result['payment'],
            'iframe' => $result['iframe_url'],
        ]);
    }

    public function callback(Request $request)
    {
        try {
            $payment = $this->paymentService->handleCallback($request->all());
            
            return redirect()->route('payment.result', [
                'status' => $payment->status,
                'reference' => $payment->reference,
            ]);
        } catch (\Exception $e) {
            return redirect()->route('payment.result', [
                'status' => 'failed',
                'error' => 'Payment verification failed',
            ]);
        }
    }

    public function webhook(Request $request)
    {
        // ูุนุงูุฌุฉ ูู ุงูุฎูููุฉ ููุณุฑุนุฉ
        ProcessPaymentCallback::dispatch($request->all());
        
        return response()->json(['status' => 'received'], 200);
    }
}
```

### Routes

```php
// routes/web.php
Route::middleware(['auth'])->prefix('payment')->group(function () {
    Route::post('/initiate', [PaymentController::class, 'initiate'])
        ->name('payment.initiate')
        ->middleware('throttle:payments');
    
    Route::get('/callback', [PaymentController::class, 'callback'])
        ->name('payment.callback')
        ->withoutMiddleware(['auth']);
    
    Route::get('/result', [PaymentController::class, 'result'])
        ->name('payment.result');
});

// Webhook route - ุจุฏูู CSRF
Route::post('/webhooks/paymob', [PaymentController::class, 'webhook'])
    ->name('payment.webhook')
    ->withoutMiddleware([\App\Http\Middleware\VerifyCsrfToken::class]);
```

---

## Filament 4 Integration

### PaymentResource

```php
// app/Filament/Resources/PaymentResource.php
namespace App\Filament\Resources;

use App\Filament\Resources\PaymentResource\Pages;
use App\Models\Payment;
use Filament\Forms;
use Filament\Forms\Form;
use Filament\Resources\Resource;
use Filament\Tables;
use Filament\Tables\Table;
use Filament\Notifications\Notification;
use Filament\Tables\Filters\SelectFilter;
use Filament\Tables\Filters\Filter;
use Illuminate\Database\Eloquent\Builder;

class PaymentResource extends Resource
{
    protected static ?string $model = Payment::class;
    protected static ?string $navigationIcon = 'heroicon-o-banknotes';
    protected static ?string $navigationGroup = 'Finance';
    protected static ?int $navigationSort = 1;

    public static function form(Form $form): Form
    {
        return $form->schema([
            Forms\Components\Section::make('Payment Details')
                ->schema([
                    Forms\Components\TextInput::make('reference')
                        ->required()
                        ->disabled(),
                    Forms\Components\Select::make('user_id')
                        ->relationship('user', 'name')
                        ->searchable()
                        ->required(),
                    Forms\Components\TextInput::make('amount')
                        ->numeric()
                        ->prefix('EGP')
                        ->required(),
                    Forms\Components\Select::make('payment_method')
                        ->options([
                            'vodafone_cash' => 'Vodafone Cash',
                            'orange_money' => 'Orange Money',
                            'etisalat_cash' => 'Etisalat Cash',
                            'credit_card' => 'Credit Card',
                            'meeza' => 'Meeza',
                            'fawry' => 'Fawry',
                        ])
                        ->required(),
                    Forms\Components\Select::make('status')
                        ->options([
                            'pending' => 'Pending',
                            'processing' => 'Processing',
                            'completed' => 'Completed',
                            'failed' => 'Failed',
                            'refunded' => 'Refunded',
                        ])
                        ->required(),
                ])->columns(2),
            
            Forms\Components\Section::make('Gateway Information')
                ->schema([
                    Forms\Components\TextInput::make('transaction_id')
                        ->disabled(),
                    Forms\Components\TextInput::make('gateway_reference')
                        ->disabled(),
                    Forms\Components\Textarea::make('failure_reason')
                        ->disabled()
                        ->columnSpanFull(),
                ])->columns(2)->collapsible(),
        ]);
    }

    public static function table(Table $table): Table
    {
        return $table
            ->columns([
                Tables\Columns\TextColumn::make('reference')
                    ->searchable()
                    ->copyable()
                    ->sortable(),
                Tables\Columns\TextColumn::make('user.name')
                    ->searchable()
                    ->sortable(),
                Tables\Columns\TextColumn::make('amount')
                    ->money('EGP')
                    ->sortable(),
                Tables\Columns\TextColumn::make('payment_method')
                    ->badge()
                    ->formatStateUsing(fn ($state) => match($state) {
                        'vodafone_cash' => 'Vodafone Cash',
                        'credit_card' => 'Credit Card',
                        default => ucfirst(str_replace('_', ' ', $state)),
                    }),
                Tables\Columns\BadgeColumn::make('status')
                    ->colors([
                        'warning' => 'pending',
                        'primary' => 'processing',
                        'success' => 'completed',
                        'danger' => 'failed',
                        'gray' => 'refunded',
                    ]),
                Tables\Columns\TextColumn::make('created_at')
                    ->dateTime('M j, Y H:i')
                    ->sortable(),
            ])
            ->defaultSort('created_at', 'desc')
            ->filters([
                SelectFilter::make('status')
                    ->options([
                        'pending' => 'Pending',
                        'completed' => 'Completed',
                        'failed' => 'Failed',
                        'refunded' => 'Refunded',
                    ]),
                SelectFilter::make('payment_method')
                    ->options([
                        'vodafone_cash' => 'Vodafone Cash',
                        'credit_card' => 'Credit Card',
                        'fawry' => 'Fawry',
                    ]),
                Filter::make('created_at')
                    ->form([
                        Forms\Components\DatePicker::make('from'),
                        Forms\Components\DatePicker::make('until'),
                    ])
                    ->query(function (Builder $query, array $data): Builder {
                        return $query
                            ->when($data['from'], fn ($q, $date) => $q->whereDate('created_at', '>=', $date))
                            ->when($data['until'], fn ($q, $date) => $q->whereDate('created_at', '<=', $date));
                    }),
            ])
            ->actions([
                Tables\Actions\Action::make('refund')
                    ->icon('heroicon-o-arrow-uturn-left')
                    ->color('warning')
                    ->requiresConfirmation()
                    ->modalHeading('Refund Payment')
                    ->modalDescription('Are you sure you want to refund this payment?')
                    ->visible(fn (Payment $record) => $record->canBeRefunded())
                    ->action(function (Payment $record) {
                        app(PaymentService::class)->refund($record);
                        Notification::make()
                            ->title('Payment refunded successfully')
                            ->success()
                            ->send();
                    }),
                Tables\Actions\ViewAction::make(),
            ])
            ->bulkActions([
                Tables\Actions\BulkAction::make('export')
                    ->icon('heroicon-o-document-arrow-down')
                    ->action(fn ($records) => /* export logic */),
            ]);
    }

    public static function getPages(): array
    {
        return [
            'index' => Pages\ListPayments::route('/'),
            'view' => Pages\ViewPayment::route('/{record}'),
        ];
    }
}
```

### PaymentStatsWidget

```php
// app/Filament/Widgets/PaymentStatsWidget.php
namespace App\Filament\Widgets;

use App\Models\Payment;
use Filament\Widgets\StatsOverviewWidget;
use Filament\Widgets\StatsOverviewWidget\Stat;

class PaymentStatsWidget extends StatsOverviewWidget
{
    protected function getStats(): array
    {
        $todayRevenue = Payment::completed()
            ->whereDate('created_at', today())
            ->sum('amount');

        $monthlyRevenue = Payment::completed()
            ->whereMonth('created_at', now()->month)
            ->sum('amount');

        $pendingCount = Payment::pending()->count();
        $failedToday = Payment::where('status', 'failed')
            ->whereDate('created_at', today())
            ->count();

        return [
            Stat::make('Today Revenue', number_format($todayRevenue, 2) . ' EGP')
                ->description('Total completed today')
                ->descriptionIcon('heroicon-m-arrow-trending-up')
                ->color('success'),
            
            Stat::make('Monthly Revenue', number_format($monthlyRevenue, 2) . ' EGP')
                ->description('This month total')
                ->color('primary'),
            
            Stat::make('Pending Payments', $pendingCount)
                ->description('Awaiting processing')
                ->color('warning'),
            
            Stat::make('Failed Today', $failedToday)
                ->description('Need attention')
                ->color($failedToday > 0 ? 'danger' : 'gray'),
        ];
    }
}
```

---

## Security Best Practices

### Webhook Verification Middleware

```php
// app/Http/Middleware/VerifyPaymobWebhook.php
namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;

class VerifyPaymobWebhook
{
    public function handle(Request $request, Closure $next)
    {
        $hmacSecret = config('nafezly-payments.PAYMOB_HMAC');
        $receivedHmac = $request->input('hmac');
        
        if (!$receivedHmac) {
            abort(403, 'Missing HMAC signature');
        }
        
        // ุญุณุงุจ HMAC ุงููุชููุน
        $data = $request->input('obj', []);
        $fields = [
            'amount_cents', 'created_at', 'currency', 'error_occured',
            'has_parent_transaction', 'id', 'integration_id', 'is_3d_secure',
            'is_auth', 'is_capture', 'is_refunded', 'is_standalone_payment',
            'is_voided', 'order.id', 'owner', 'pending',
            'source_data.pan', 'source_data.sub_type', 'source_data.type', 'success'
        ];
        
        $concatenated = '';
        foreach ($fields as $field) {
            $concatenated .= data_get($data, $field, '');
        }
        
        $expectedHmac = hash_hmac('sha512', $concatenated, $hmacSecret);
        
        if (!hash_equals($expectedHmac, $receivedHmac)) {
            abort(403, 'Invalid HMAC signature');
        }
        
        return $next($request);
    }
}
```

### Rate Limiting ูููุฏููุนุงุช

```php
// app/Providers/AppServiceProvider.php
use Illuminate\Cache\RateLimiting\Limit;
use Illuminate\Support\Facades\RateLimiter;

public function boot(): void
{
    RateLimiter::for('payments', function ($request) {
        return Limit::perMinute(5)->by($request->user()?->id ?: $request->ip());
    });
}
```

### Idempotency Middleware

```php
// app/Http/Middleware/EnsureIdempotency.php
namespace App\Http\Middleware;

use Closure;
use Illuminate\Support\Facades\Cache;

class EnsureIdempotency
{
    public function handle($request, Closure $next)
    {
        $key = $request->header('Idempotency-Key');
        
        if (!$key) {
            return $next($request);
        }
        
        $cacheKey = "idempotency:{$key}";
        
        if ($cached = Cache::get($cacheKey)) {
            return response()->json($cached['data'], $cached['status'])
                ->header('Idempotency-Replayed', 'true');
        }
        
        $response = $next($request);
        
        Cache::put($cacheKey, [
            'data' => $response->getData(),
            'status' => $response->getStatusCode(),
        ], now()->addHours(24));
        
        return $response;
    }
}
```

---

## Testing

### Feature Test ูููุฏููุนุงุช

```php
// tests/Feature/PaymentTest.php
namespace Tests\Feature;

use App\Models\User;
use App\Models\Payment;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Tests\TestCase;

class PaymentTest extends TestCase
{
    use RefreshDatabase;

    public function test_user_can_initiate_payment()
    {
        $user = User::factory()->create();
        
        $response = $this->actingAs($user)
            ->postJson('/payment/initiate', [
                'amount' => 100.00,
                'payment_method' => 'vodafone_cash',
                'source' => '01012345678',
            ]);
        
        $response->assertStatus(200)
            ->assertJsonStructure(['success', 'payment']);
        
        $this->assertDatabaseHas('payments', [
            'user_id' => $user->id,
            'amount' => 100.00,
            'status' => 'pending',
        ]);
    }

    public function test_webhook_updates_payment_status()
    {
        $payment = Payment::factory()->create([
            'status' => 'pending',
            'gateway_reference' => '12345',
        ]);
        
        $webhookData = [
            'payment_id' => '12345',
            'success' => 'true',
            'transaction_id' => 'TXN_123',
            'hmac' => $this->generateValidHmac([...]),
        ];
        
        $response = $this->postJson('/webhooks/paymob', $webhookData);
        
        $response->assertStatus(200);
        
        $this->assertDatabaseHas('payments', [
            'id' => $payment->id,
            'status' => 'completed',
            'transaction_id' => 'TXN_123',
        ]);
    }

    public function test_rate_limiting_blocks_excessive_requests()
    {
        $user = User::factory()->create();
        
        for ($i = 0; $i < 6; $i++) {
            $response = $this->actingAs($user)
                ->postJson('/payment/initiate', [
                    'amount' => 100,
                    'payment_method' => 'credit_card',
                ]);
        }
        
        $response->assertStatus(429);
    }
}
```

---

## ููู ุงูุชูููู ุงููุงูู

```php
// config/nafezly-payments.php
return [
    // Paymob Configuration
    'PAYMOB_API_KEY' => env('PAYMOB_API_KEY'),
    'PAYMOB_INTEGRATION_ID' => env('PAYMOB_INTEGRATION_ID'),
    'PAYMOB_IFRAME_ID' => env('PAYMOB_IFRAME_ID'),
    'PAYMOB_HMAC' => env('PAYMOB_HMAC'),
    'PAYMOB_WALLET_INTEGRATION_ID' => env('PAYMOB_WALLET_INTEGRATION_ID'),
    
    // Fawry Configuration
    'FAWRY_URL' => env('FAWRY_URL', 'https://atfawry.com'),
    'FAWRY_MERCHANT' => env('FAWRY_MERCHANT'),
    'FAWRY_SECRET' => env('FAWRY_SECRET'),
    
    // General Settings
    'VERIFY_ROUTE_NAME' => 'payment.callback',
    'APP_NAME' => env('APP_NAME', 'My App'),
];
```

```env
# .env
PAYMOB_API_KEY=your_api_key_here
PAYMOB_INTEGRATION_ID=your_integration_id
PAYMOB_IFRAME_ID=your_iframe_id
PAYMOB_HMAC=your_hmac_secret
PAYMOB_WALLET_INTEGRATION_ID=your_wallet_integration_id

FAWRY_URL=https://atfawry.com
FAWRY_MERCHANT=your_merchant_code
FAWRY_SECRET=your_secret_key
```

---

## ุงูุฎูุงุตุฉ ูุงูุชูุตูุงุช

ููุชูุงูู ุงููุงุฌุญ ูุน ูุณุงุฆู ุงูุฏูุน ุงููุตุฑูุฉ ูู Laravel 12 ูุน Filament 4ุ ุงุชุจุน ูุฐู ุงูุฎุทูุงุช:

1. **ุงุณุชุฎุฏู Paymob** ูุจูุงุจุฉ ุฏูุน ุฑุฆูุณูุฉ - ุชุฏุนู ุฌููุน ุงููุญุงูุธ ุงููุตุฑูุฉ ูุชููุฑ ุฃูุถู ุชูุซูู
2. **ุซุจูุช nafezly/payments** - ุฃุดูู package ููุฏูุน ุงููุตุฑู ูุน ุฏุนู 30+ ุจูุงุจุฉ
3. **ุทุจูู Security Best Practices** - HMAC verificationุ Rate limitingุ Idempotency
4. **ุงุณุชุฎุฏู Queue Jobs** ููุนุงูุฌุฉ Webhooks ุจุดูู ุบูุฑ ูุชุฒุงูู
5. **ุฃูุดุฆ Filament Resource** ูุฅุฏุงุฑุฉ ุงููุนุงููุงุช ูู ููุญุฉ ุงูุชุญูู

**ุฅูุณุชุงุจุงู ุบูุฑ ูุชุงุญ ููุชูุงูู ุงููุจุงุดุฑ ุญุงููุงู** - ุงูุชุธุฑ ุฏุนู Paymob ุงููุงุฏู ุฃู ุงุณุชุฎุฏู QR Code ูุญู ูุคูุช.

---

## ุงููุตุงุฏุฑ ูุงูุฑูุงุจุท ุงููููุฉ

- **Paymob Developer Portal**: https://developers.paymob.com/egypt
- **nafezly/payments Documentation**: https://github.com/Nafezly/payments
- **Laravel 12 Documentation**: https://laravel.com/docs/12.x
- **Filament 4 Documentation**: https://filamentphp.com/docs/4.x
- **ููุฏุงููู ูุงุด**: https://web.vodafone.com.eg/ar/vodafone-cash
- **ุฅูุณุชุงุจุงู**: https://www.instapay.eg